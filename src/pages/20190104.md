---
date: '2018-08-01'
title: MiniMagickのソースを読む①
tags: ['ruby', 'MiniMagick']
description: 'MiniMagickのソースを読む①'
---

# はじめに

ruby on rails を使う際に何かとお世話になってる minimagick の内部の動作の理解とコマンドラインとの連携仕方を知りたかったのでソースを読んでみた。

 今回は MiniMagick のクラス構成と役割を調べてみる。

minimagick は `module MiniMagick` 内に各処理をする為のクラスが存在する。

- MiniMagick
  - Configuration(module)
  - Image
    - Info
  - Shell
  - Tool
    - Animate
    - Compare
    - Composite
    - Conjure
    - Convert
    - Display
    - Identify
    - Import
    - Magick
    - MogrifyRestricted
    - Mogrify
    - Montage
    - Stream
  - Utilities(module)
  - VERSION(module)

各クラスの役割をざっくり解説していく

## Image

 画像ファイルの読み込みから各クラスのメソッドを使う為の基点となるクラス
画像の加工、書き出しまで基本このクラスで行う。

 インスタンス作成時に`tempfile`を使ってファイルのコピーを作成して使うので元の画像には影響を与えない。

```ruby
image = Magick::Image.read(file)
```

## Tool

imagemagick のコマンドを作成するクラス
`class Tool`が親クラスになっていて子クラスに`Magick`等が存在する。
`MogrifyRestricted`を除いた子クラスは全てこんな感じ

```ruby
class Magick < MiniMagick::Tool
  def initialize(*args)
    super("magick", *args)
  end
end
```

`super`の第一  引数が違うだけでそれ以外に差異はない。

## Shell

`Tool`で作成したコマンドを実行するクラス。
内部ではコマンドの実行に`open3`か`posix-spawn`が使われている。

デフォルトでは`open3`が使用され、容量の大きい画像を扱いメモリが枯渇して`Errno::ENOMEM`の例外を投げられるケースで`posix-spawn`を使うようドキュメントに書かれている。

## Configuration

コンフィグ

## Utilities

 どのライブライにでもある Util メソッド用のクラス。
`which`と`tempfile`の 2 つのメソッドしかない。
`which`のやりたいことは linux コマンドの`which`と同じ。
`tempfile`は`Image` のインスタンスを作成する際に使われる。
block を渡して任意の処理を実行できる。

```ruby
def tempfile(extension)
  Tempfile.new(["mini_magick", extension]).tap do |tempfile|
    tempfile.binmode
    yield tempfile if block_given?
    tempfile.close
  end
end
```
